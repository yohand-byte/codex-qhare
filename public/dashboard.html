<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DP Auto Pack ‚Äì Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0e1116;
      --panel: #161b22;
      --accent: #19c37d;
      --text: #e6edf3;
      --muted: #8b97a3;
      --border: #1f2530;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(25,195,125,0.08), transparent 32%), var(--bg);
      color: var(--text);
    }
    h1 { margin: 0 0 8px; font-weight: 600; letter-spacing: -0.02em; }
    p.lead { margin: 0 0 24px; color: var(--muted); }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.25);
    }
    label { display: block; margin: 10px 0 4px; font-size: 13px; color: var(--muted); }
    input, textarea, select, button {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0d1117;
      color: var(--text);
      padding: 10px 12px;
      font: inherit;
    }
    button {
      margin-top: 12px;
      background: linear-gradient(135deg, #19c37d, #12a366);
      color: #04150c;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 10px 25px rgba(25,195,125,0.35); }
    pre {
      background: #0b0f14;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      color: #c8d1dc;
      font-size: 13px;
    }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(25,195,125,0.15);
      color: var(--text);
      font-size: 12px;
      border: 1px solid rgba(25,195,125,0.35);
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>DP Auto Pack ¬∑ Dashboard</h1>
    <p class="lead">Pilotage rapide du bridge Odoo et de l‚ÄôAPI DP. Ports utilis√©s : 3000 (bridge) et 8000 (FastAPI).</p>
  </header>

  <div class="grid">
    <section class="card">
      <h2>0) Flux Qhare ‚Üí DP</h2>
      <label for="qhareLeadUrl">Lien lead Qhare</label>
      <input id="qhareLeadUrl" value="https://qhare.fr/leads/566980/edit" />
      <div class="row">
        <input id="qhareLeadId" placeholder="ID lead (optionnel)" />
        <input id="qhareMaxDocs" type="number" min="1" max="10" value="3" placeholder="Docs max" />
      </div>
      <label for="qhareApiKey">X-API-Key (FastAPI pour auto DP)</label>
      <input id="qhareApiKey" value="Hashem0409@" />
      <div class="row">
        <button onclick="loadQhareLead()">Charger lead</button>
        <button onclick="fillFromQhare()">Remplir formulaire</button>
        <button onclick="autoGenerateQhare()">Auto /generate (Qhare)</button>
      </div>
      <div class="pill" id="qhareLeadStatus">En attente</div>
      <pre id="qhareLeadResult">R√©sultat Qhare‚Ä¶</pre>
      <p class="lead" style="margin-top:12px;">Docs Qhare (miniatures)</p>
      <div class="doc-grid" id="qhareDocGallery"></div>
      <p class="lead" style="margin-top:12px;">Docs DP g√©n√©r√©</p>
      <div class="doc-grid" id="qhareGenGallery"></div>
    </section>

    <section class="card">
      <h2>1) Lister un dossier Odoo</h2>
      <label for="odooUrl">URL dossier Odoo</label>
      <input id="odooUrl" placeholder="https://solaire.qualiwatt.com/odoo/documents/XXXX" />
      <label for="sessionCookie">Session cookie (optionnel)</label>
      <input id="sessionCookie" placeholder="session_id=..." />
      <button onclick="listOdoo()">Lister</button>
      <div class="pill" id="odooStatus">En attente</div>
      <pre id="odooResult">R√©sultat JSON‚Ä¶</pre>
    </section>

    <section class="card">
      <h2>2) G√©n√©rer un DP</h2>
      <div class="row">
        <div>
          <label for="prenom">Pr√©nom</label>
          <input id="prenom" value="Georges" />
        </div>
        <div>
          <label for="nom">Nom</label>
          <input id="nom" value="Nedjar" />
        </div>
      </div>
      <label for="adresse">Adresse</label>
      <div class="row">
        <input id="numero" value="17" placeholder="N¬∞" />
        <input id="voie" value="Rue Jaum√©" placeholder="Voie" />
      </div>
      <div class="row">
        <input id="ville" value="Ch√¢teauneuf-les-Martigues" placeholder="Ville" />
        <input id="cp" value="13220" placeholder="Code postal" />
      </div>
      <label for="description">Description installation</label>
      <textarea id="description" rows="2">Puissance max, surimposition, 500W RECOM, tri, revente totale</textarea>
      <label for="puissance">Puissance kWc</label>
      <input id="puissance" value="max" />
      <label for="lienOdoo">Lien Odoo (optionnel)</label>
      <input id="lienOdoo" value="https://solaire.qualiwatt.com/odoo/documents/XXXX" />
      <label for="apiKey">X-API-Key (FastAPI)</label>
      <input id="apiKey" value="Hashem0409@" />
      <button onclick="generate()">Lancer /generate</button>
      <div class="pill" id="genStatus">En attente</div>
      <pre id="genResult">R√©ponse API‚Ä¶</pre>
    </section>

    <section class="card">
      <h2>3) Solar API</h2>
      <p class="lead" style="margin-bottom:12px;">Pilote les endpoints <code>dataLayers</code>, <code>buildingInsights</code> et <code>geoTiff</code> avec ta cl√© serveur.</p>
      <h3 style="margin-top:0;">Data Layers</h3>
      <div class="row">
        <input id="solarLat" value="48.8566" placeholder="Latitude" />
        <input id="solarLon" value="2.3522" placeholder="Longitude" />
      </div>
      <div class="row">
        <input id="solarRadius" value="80" placeholder="Rayon (m)" />
        <input id="solarPixel" value="0.25" placeholder="Pixel (m)" />
      </div>
      <label for="solarView">Vue</label>
      <input id="solarView" value="IMAGERY_AND_ANNUAL_FLUX_LAYERS" />
      <button onclick="callSolar()">Tester layers</button>
      <div class="pill" id="solarStatus">En attente</div>
      <div class="solar-info" id="solarInfo">
        <p class="lead" style="font-size:12px;color:var(--muted);">Les informations d‚Äôimagerie s‚Äôafficheront ici.</p>
      </div>
      <pre id="solarResult">R√©ponse Solar‚Ä¶</pre>

      <h3>B√¢timent (buildingInsights)</h3>
      <div class="row">
        <input id="buildingLat" value="48.8566" placeholder="Latitude" />
        <input id="buildingLon" value="2.3522" placeholder="Longitude" />
      </div>
      <div class="row">
        <select id="buildingQuality">
          <option value="HIGH" selected>HIGH</option>
          <option value="MEDIUM">MEDIUM</option>
          <option value="LOW">LOW</option>
        </select>
      </div>
      <button onclick="callBuilding()">Obtenir building insights</button>
      <div class="pill" id="buildingStatus">En attente</div>
      <div class="solar-info" id="buildingInfo">
        <p class="lead" style="font-size:12px;color:var(--muted);">R√©sum√© b√¢timent affich√© ici.</p>
      </div>
      <pre id="buildingResult">R√©ponse building‚Ä¶</pre>

      <h3>GeoTIFF (proxy)</h3>
      <p class="lead" style="margin-bottom:8px;">Colle l‚Äôidentifiant re√ßu (DSM/RGB/Mask/Flux) pour obtenir une URL sign√©e.</p>
      <input id="geotiffId" placeholder="GeoTIFF id=..." />
      <button onclick="buildGeoTiff()">G√©n√©rer lien GeoTIFF</button>
      <div class="pill" id="geotiffStatus">En attente</div>
      <div class="solar-info" id="geotiffInfo">
        <p class="lead" style="font-size:12px;color:var(--muted);">Lien g√©n√©r√© ici.</p>
      </div>
    </section>

    <section class="card">
      <h2>4) Webhook Qhare</h2>
      <p class="lead" style="margin-bottom:8px;">Configure dans Qhare l‚ÄôURL suivante (tunnel Cloudflare) :</p>
      <input id="qhareUrl" value="https://vanilla-birth-uses-bath.trycloudflare.com/webhooks/qhare" />
      <div class="row">
        <input id="qhNom" placeholder="Nom" value="Foussier" />
        <input id="qhPrenom" placeholder="Pr√©nom" value="Bertrand" />
      </div>
      <div class="row">
        <input id="qhNumero" placeholder="N¬∞" value="14" />
        <input id="qhVoie" placeholder="Rue" value="Rue Emile Nicol" />
      </div>
      <div class="row">
        <input id="qhVille" placeholder="Ville" value="Dozul√©" />
        <input id="qhCp" placeholder="Code postal" value="14430" />
      </div>
      <label for="qhDesc">Description</label>
      <textarea id="qhDesc" rows="2">Panneau photovolta√Øque ‚Äì test webhook local</textarea>
      <button onclick="sendQhare()">Tester via /webhooks/qhare (local)</button>
      <div class="pill" id="qhareStatus">En attente</div>
      <pre id="qhareResult">R√©ponse webhook‚Ä¶</pre>
      <p class="lead" style="margin-top:12px;">Rappel Qhare : √©v√©nements Cr√©ation/Modification/Suppression ‚ÄúLeads et Clients‚Äù ‚Üí POST JSON vers l‚ÄôURL ci-dessus. Les URLs trouv√©es (pdf/png/jpg/webp) sont t√©l√©charg√©es dans `dp_final/DP_<Client>/attachments/`.</p>
    </section>
  </div>

  <script>
    let qhareBundle = null;
    const summarizeDocs = docs => {
      if (!Array.isArray(docs)) return [];
      const seen = new Set();
      const iconFor = name => {
        if (!name) return "üìÑ";
        const ext = name.split(".").pop()?.toLowerCase();
        if (["jpg", "jpeg", "png", "webp", "gif"].includes(ext)) return "üñºÔ∏è";
        if (["pdf"].includes(ext)) return "üßæ";
        if (["zip", "rar7z", "rar", "7z"].includes(ext)) return "üì¶";
        if (["doc", "docx"].includes(ext)) return "üìÉ";
        if (["xls", "xlsx", "csv"].includes(ext)) return "üìä";
        return "üìÑ";
      };
      const pickName = doc => {
        if (!doc) return null;
        if (doc.filename) return doc.filename;
        if (typeof doc.saved_as === "string") return doc.saved_as.split("/").pop();
        if (typeof doc.url === "string") return doc.url.split("/").pop();
        return null;
      };
      const list = [];
      for (const doc of docs) {
        const name = pickName(doc);
        if (!name || seen.has(name)) continue;
        seen.add(name);
        list.push(`${iconFor(name)} ${name}`);
      }
      return list;
    };

    const formatQhareBundle = bundle => ({
      leadId: bundle.leadId,
      contact: bundle.contact,
      address: bundle.address,
      summary: bundle.summary,
      missing: bundle.missing,
      documents: summarizeDocs(bundle.documents),
    });

    const formatGenerateResult = data => ({
      status: data.status,
      file: data.file,
      path: data.path,
      request_dir: data.request_dir,
      inline_documents: summarizeDocs(data.inline_documents),
      attachments: summarizeDocs(data.attachments),
      qhare: data.qhare
        ? {
            leadId: data.qhare.leadId,
            summary: data.qhare.summary,
            documents: summarizeDocs(data.qhare.documents),
          }
        : undefined,
    });

    const renderDocGallery = (docs, containerId) => {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = "";
      if (!Array.isArray(docs) || !docs.length) {
        container.innerHTML = '<p class="lead" style="font-size:12px;color:var(--muted);">Aucun document disponible.</p>';
        return;
      }
      docs.slice(0, 12).forEach(doc => {
        const box = document.createElement("div");
        box.className = "doc-thumb";
        const img = document.createElement("img");
        img.alt = doc.filename || "Doc";
        box.appendChild(img);
        const caption = document.createElement("div");
        caption.className = "doc-caption";
        caption.textContent = doc.filename || doc.label || "Document";
        box.appendChild(caption);
        if (doc.url) {
          const link = document.createElement("a");
          link.href = doc.url;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = "Ouvrir";
          box.appendChild(link);
        }
        container.appendChild(box);
        if (doc.preview || doc.url) {
          loadDocPreview(img, doc.preview || doc.url, box);
        } else {
          box.classList.remove("loading");
        }
      });
    };

    const loadDocPreview = async (imgEl, sourceUrl, box) => {
      if (!sourceUrl) return;
      box.classList.add("loading");
      try {
        const res = await fetch("/qhare/document_preview", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url: sourceUrl }),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        imgEl.src = `data:${data.mime};base64,${data.base64}`;
      } catch (e) {
        imgEl.remove();
        const fallback = document.createElement("div");
        fallback.className = "doc-caption";
        fallback.textContent = "Pr√©visualisation indisponible";
        box.appendChild(fallback);
      } finally {
        box.classList.remove("loading");
      }
    };

    const renderSolarInfo = data => {
      const container = document.getElementById("solarInfo");
      if (!container) return;
      if (!data || typeof data !== "object") {
        container.innerHTML = '<p class="lead" style="font-size:12px;color:var(--muted);">Pas de donn√©es Solar.</p>';
        return;
      }
      const fmtDate = obj =>
        obj && obj.year ? `${String(obj.day || 1).padStart(2, "0")}/${String(obj.month || 1).padStart(2, "0")}/${obj.year}` : "‚Äî";
      container.innerHTML = `
        <div><strong>Date imagerie</strong>${fmtDate(data.imageryDate)}</div>
        <div><strong>Date traitement</strong>${fmtDate(data.imageryProcessedDate)}</div>
        <div><strong>Qualit√©</strong>${data.imageryQuality || "‚Äî"}</div>
        <div class="solar-links">
          ${data.rgbUrl ? `<a href="${data.rgbUrl}" target="_blank" rel="noopener noreferrer">RGB GeoTIFF</a>` : ""}
          ${data.dsmUrl ? `<a href="${data.dsmUrl}" target="_blank" rel="noopener noreferrer">DSM</a>` : ""}
          ${data.maskUrl ? `<a href="${data.maskUrl}" target="_blank" rel="noopener noreferrer">Mask</a>` : ""}
          ${data.annualFluxUrl ? `<a href="${data.annualFluxUrl}" target="_blank" rel="noopener noreferrer">Annual Flux</a>` : ""}
        </div>
      `;
    };

    const renderBuildingInfo = data => {
      const container = document.getElementById("buildingInfo");
      if (!container) return;
      if (!data || typeof data !== "object") {
        container.innerHTML = '<p class="lead" style="font-size:12px;color:var(--muted);">Pas de donn√©es.</p>';
        return;
      }
      const info = data.buildingInsights || data;
      const center = info.center || info.location || {};
      const solar = info.solarPotential || {};
      const roofStats = solar.wholeRoofStats || solar.wholeRoofStatistics || {};
      const summary = [
        { label: "Nom", value: info.name || "‚Äî" },
        {
          label: "Centre",
          value:
            center.latitude != null && center.longitude != null
              ? `${Number(center.latitude).toFixed(6)}, ${Number(center.longitude).toFixed(6)}`
              : "‚Äî",
        },
        { label: "Surface toit (m¬≤)", value: roofStats.areaMeters2 != null ? roofStats.areaMeters2.toFixed(2) : "‚Äî" },
        { label: "Panneaux max", value: solar.maxArrayPanelsCount ?? solar.maxArrayPanelCount ?? "‚Äî" },
        {
          label: "√ânergie annuelle (kWh)",
          value:
            solar.maxArrayAnnualEnergyKwh?.toLocaleString?.("fr-FR") ||
            solar.annualKwhEstimate?.toLocaleString?.("fr-FR") ||
            "‚Äî",
        },
      ];
      container.innerHTML = summary.map(item => `<div><strong>${item.label}</strong>${item.value}</div>`).join("");
    };
    const status = (el, text, ok = false) => {
      el.textContent = text;
      el.style.background = ok ? "rgba(25,195,125,0.15)" : "rgba(255,87,87,0.1)";
      el.style.borderColor = ok ? "rgba(25,195,125,0.35)" : "rgba(255,87,87,0.25)";
    };

    async function loadQhareLead() {
      const statusEl = document.getElementById("qhareLeadStatus");
      const resultEl = document.getElementById("qhareLeadResult");
      const leadUrl = document.getElementById("qhareLeadUrl").value.trim();
      const leadId = document.getElementById("qhareLeadId").value.trim();
      if (!leadUrl && !leadId) {
        status(statusEl, "URL ou ID requis", false);
        resultEl.textContent = "Merci de renseigner l‚ÄôURL ou l‚ÄôID du lead Qhare.";
        return;
      }
      status(statusEl, "Requ√™te Qhare‚Ä¶", true);
      try {
        const res = await fetch("/qhare/lead", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            leadUrl: leadUrl || undefined,
            leadId: leadId || undefined,
          }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Erreur Qhare");
        qhareBundle = data;
        status(statusEl, "Lead charg√©", true);
        resultEl.textContent = JSON.stringify(formatQhareBundle(data), null, 2);
        renderDocGallery(data.documents, "qhareDocGallery");
      } catch (e) {
        status(statusEl, "Erreur Qhare", false);
        resultEl.textContent = e.message;
      }
    }

    function fillFromQhare() {
      if (!qhareBundle || !qhareBundle.dpPayload) {
        alert("Charge d‚Äôabord un lead Qhare.");
        return;
      }
      const payload = qhareBundle.dpPayload;
      document.getElementById("prenom").value = payload.prenom_client || "";
      document.getElementById("nom").value = payload.nom_client || "";
      document.getElementById("numero").value = payload.numero_adresse || "";
      document.getElementById("voie").value = payload.voie || "";
      document.getElementById("ville").value = payload.ville || "";
      document.getElementById("cp").value = payload.code_postal || "";
      document.getElementById("description").value = payload.description_installation || "";
      document.getElementById("puissance").value = payload.puissance_kwc || "max";
      document.getElementById("lienOdoo").value = qhareBundle.leadUrl || "";
      const statusEl = document.getElementById("qhareLeadStatus");
      status(statusEl, "Formulaire pr√©-rempli", true);
    }

    async function autoGenerateQhare() {
      const statusEl = document.getElementById("qhareLeadStatus");
      const resultEl = document.getElementById("qhareLeadResult");
      const leadUrl = document.getElementById("qhareLeadUrl").value.trim();
      const leadId = document.getElementById("qhareLeadId").value.trim();
      const apiKey = document.getElementById("qhareApiKey").value.trim() || document.getElementById("apiKey").value.trim();
      const maxDocuments = parseInt(document.getElementById("qhareMaxDocs").value, 10) || 3;
      if (!apiKey) {
        status(statusEl, "API key manquante", false);
        resultEl.textContent = "Merci de renseigner une cl√© FastAPI.";
        return;
      }
      if (!leadUrl && !leadId) {
        status(statusEl, "URL ou ID requis", false);
        resultEl.textContent = "Merci de renseigner l‚ÄôURL ou l‚ÄôID du lead Qhare.";
        return;
      }
      status(statusEl, "Auto /generate‚Ä¶", true);
      try {
        const res = await fetch("/qhare/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            leadUrl: leadUrl || undefined,
            leadId: leadId || undefined,
            apiKey,
            maxDocuments,
          }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || data.detail || "Erreur FastAPI");
        status(statusEl, "DP g√©n√©r√©", true);
        resultEl.textContent = JSON.stringify(formatGenerateResult(data), null, 2);
        if (data.qhare?.documents) {
          renderDocGallery(data.qhare.documents, "qhareGenGallery");
        }
      } catch (e) {
        status(statusEl, "Erreur g√©n√©ration", false);
        resultEl.textContent = e.message;
      }
    }

    async function callSolar() {
      const statusEl = document.getElementById("solarStatus");
      const resultEl = document.getElementById("solarResult");
      const latitude = parseFloat(document.getElementById("solarLat").value);
      const longitude = parseFloat(document.getElementById("solarLon").value);
      const radius = parseFloat(document.getElementById("solarRadius").value) || 80;
      const pixel = parseFloat(document.getElementById("solarPixel").value) || 0.25;
      const view = document.getElementById("solarView").value.trim() || "IMAGERY_AND_ANNUAL_FLUX_LAYERS";
      if (Number.isNaN(latitude) || Number.isNaN(longitude)) {
        status(statusEl, "Latitude/Longitude invalides", false);
        resultEl.textContent = "Merci de renseigner deux nombres valides.";
        return;
      }
      status(statusEl, "Requ√™te Solar‚Ä¶", true);
      try {
        const res = await fetch("/solar/data", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            latitude,
            longitude,
            radiusMeters: radius,
            pixelSizeMeters: pixel,
            view,
          }),
        });
        const data = await res.json();
        status(statusEl, res.ok ? "OK" : `Erreur ${res.status}`, res.ok);
        resultEl.textContent = JSON.stringify(data, null, 2);
        if (res.ok) renderSolarInfo(data);
      } catch (e) {
        status(statusEl, "Erreur Solar", false);
        resultEl.textContent = e.message;
      }
    }

    async function callBuilding() {
      const statusEl = document.getElementById("buildingStatus");
      const resultEl = document.getElementById("buildingResult");
      const latitude = parseFloat(document.getElementById("buildingLat").value);
      const longitude = parseFloat(document.getElementById("buildingLon").value);
      const requiredQuality = document.getElementById("buildingQuality").value;
      if (Number.isNaN(latitude) || Number.isNaN(longitude)) {
        status(statusEl, "Latitude/Longitude invalides", false);
        resultEl.textContent = "Merci de renseigner deux nombres valides.";
        return;
      }
      status(statusEl, "Requ√™te building‚Ä¶", true);
      try {
        const res = await fetch("/solar/building_insights", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ latitude, longitude, requiredQuality }),
        });
        const data = await res.json();
        status(statusEl, res.ok ? "OK" : `Erreur ${res.status}`, res.ok);
        resultEl.textContent = JSON.stringify(data, null, 2);
        if (res.ok) renderBuildingInfo(data);
      } catch (e) {
        status(statusEl, "Erreur building", false);
        resultEl.textContent = e.message;
      }
    }

    async function buildGeoTiff() {
      const statusEl = document.getElementById("geotiffStatus");
      const infoEl = document.getElementById("geotiffInfo");
      const id = document.getElementById("geotiffId").value.trim();
      if (!id) {
        status(statusEl, "ID requis", false);
        infoEl.innerHTML = '<p class="lead" style="font-size:12px;color:var(--muted);">Renseigne un identifiant.</p>';
        return;
      }
      status(statusEl, "G√©n√©ration‚Ä¶", true);
      try {
        const res = await fetch("/solar/geotiff", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id }),
        });
        const data = await res.json();
        status(statusEl, res.ok ? "OK" : `Erreur ${res.status}`, res.ok);
        if (!res.ok) {
          infoEl.innerHTML = `<p class="lead" style="font-size:12px;color:var(--muted);">${data.error || "Erreur"}</p>`;
          return;
        }
        infoEl.innerHTML = `<a href="${data.url}" target="_blank" rel="noopener noreferrer">${data.url}</a>`;
      } catch (e) {
        status(statusEl, "Erreur GeoTIFF", false);
        infoEl.innerHTML = `<p class="lead" style="font-size:12px;color:var(--muted);">${e.message}</p>`;
      }
    }

    async function listOdoo() {
      const url = document.getElementById("odooUrl").value.trim();
      const sessionCookie = document.getElementById("sessionCookie").value.trim();
      const statusEl = document.getElementById("odooStatus");
      const resultEl = document.getElementById("odooResult");
      status(statusEl, "Requ√™te‚Ä¶", true);
      try {
        const res = await fetch("/list_odoo_folder", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url, sessionCookie: sessionCookie || undefined }),
        });
        const data = await res.json();
        status(statusEl, res.ok ? "OK" : `Erreur ${res.status}`, res.ok);
        resultEl.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        status(statusEl, "Erreur r√©seau", false);
        resultEl.textContent = e.message;
      }
    }

    async function generate() {
      const statusEl = document.getElementById("genStatus");
      const resultEl = document.getElementById("genResult");
      status(statusEl, "Requ√™te‚Ä¶", true);
      const payload = {
        nom_client: document.getElementById("nom").value,
        prenom_client: document.getElementById("prenom").value,
        numero_adresse: document.getElementById("numero").value,
        voie: document.getElementById("voie").value,
        ville: document.getElementById("ville").value,
        code_postal: document.getElementById("cp").value,
        prefixe_cadastre: "",
        section_cadastre: "",
        numero_cadastre: "",
        superficie_cadastre: "",
        description_installation: document.getElementById("description").value,
        puissance_kwc: document.getElementById("puissance").value,
        lien_odoo: document.getElementById("lienOdoo").value || null,
        date_signature: null,
      };
      try {
        const res = await fetch("http://127.0.0.1:8000/generate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-API-Key": document.getElementById("apiKey").value,
          },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        status(statusEl, res.ok ? "OK" : `Erreur ${res.status}`, res.ok);
        resultEl.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        status(statusEl, "Erreur r√©seau", false);
        resultEl.textContent = e.message;
      }
    }

    async function sendQhare() {
      const statusEl = document.getElementById("qhareStatus");
      const resultEl = document.getElementById("qhareResult");
      status(statusEl, "Requ√™te‚Ä¶", true);
      const payload = {
        first_name: document.getElementById("qhPrenom").value,
        last_name: document.getElementById("qhNom").value,
        street_number: document.getElementById("qhNumero").value,
        street: document.getElementById("qhVoie").value,
        city: document.getElementById("qhVille").value,
        zip: document.getElementById("qhCp").value,
        project_description: document.getElementById("qhDesc").value,
        power_kwc: "max"
      };
      try {
        const res = await fetch("http://127.0.0.1:8000/webhooks/qhare", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        status(statusEl, res.ok ? "OK" : `Erreur ${res.status}`, res.ok);
        resultEl.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        status(statusEl, "Erreur r√©seau", false);
        resultEl.textContent = e.message;
      }
    }
  </script>
</body>
</html>
    .doc-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }
    .doc-thumb {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      background: #0b0f14;
      min-height: 140px;
    }
    .doc-thumb img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      display: block;
      background: #050708;
    }
    .doc-caption {
      font-size: 11px;
      padding: 6px;
      line-height: 1.2;
      color: var(--text);
    }
    .doc-thumb a {
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 12px;
      background: rgba(4, 21, 12, 0.8);
      color: var(--accent);
      padding: 2px 6px;
      border-radius: 999px;
      text-decoration: none;
    }
    .doc-thumb.loading::after {
      content: "Chargement‚Ä¶";
      position: absolute;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      color: var(--muted);
    }
    .solar-info {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      background: #0b1018;
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.4;
    }
    .solar-info strong {
      display: inline-block;
      width: 140px;
      color: var(--muted);
      font-weight: 500;
    }
    .solar-links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 6px;
      margin-top: 8px;
    }
    .solar-links a {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 8px;
      text-decoration: none;
      font-size: 12px;
      color: var(--accent);
      background: rgba(25,195,125,0.08);
    }
